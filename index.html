<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlloCate - ETF Portfolio Designer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; 
        }
        .card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 1.5rem;
            padding: 1.5rem;
        }
        .details-content {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        .details-content.open {
            display: block;
        }
        .arrow-icon {
            transition: transform 0.3s ease;
        }
        .arrow-icon.rotated {
            transform: rotate(180deg);
        }
        .details-list {
            max-height: 200px;
            overflow-y: auto;
            padding-right: 8px; 
        }
        .details-list::-webkit-scrollbar { width: 6px; }
        .details-list::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        .details-list::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        .details-list::-webkit-scrollbar-thumb:hover { background: #555; }
        .tooltip { position: relative; display: inline-block; cursor: help; }
        .tooltip .tooltiptext {
            visibility: hidden; width: 220px; background-color: #555; color: #fff; text-align: center;
            border-radius: 6px; padding: 5px 0; position: absolute; z-index: 1; bottom: 125%;
            left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 0.875rem;
        }
        .tooltip .tooltiptext::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: #555 transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .video-container video { max-width: 100%; height: auto; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        
        .ai-feature-card { border-left-width: 4px; }
        .ai-insights-card { background-color: #e0f2fe; border-color: #0ea5e9; } /* Blue */
        .diversification-suggestions-card { background-color: #e0fbf4; border-color: #10b981; } /* Green */
        .ai-profile-refinement-card { background-color: #ffedd5; border-color: #f97316; } /* Orange */
        .ai-difference-analysis-card { background-color: #ede9fe; border-color: #8b5cf6; } /* Purple */


        .pulsing-dots span {
            display: inline-block; width: 8px; height: 8px; margin: 0 2px;
            background-color: #0ea5e9; border-radius: 50%;
            animation: pulse 1.4s infinite ease-in-out both;
        }
        .diversification-suggestions-card .pulsing-dots span { background-color: #10b981; }
        .ai-profile-refinement-card .pulsing-dots span { background-color: #f97316; } 
        .ai-difference-analysis-card .pulsing-dots span { background-color: #8b5cf6; } /* Purple dots */


        .pulsing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .pulsing-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes pulse { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        
        #aiProfileRefinementRationale, .ai-analysis-section {
            margin-top: 0.75rem; padding: 0.75rem;
            border-radius: 0.375rem; font-size: 0.875rem; 
            line-height: 1.25rem; 
        }
        #aiProfileRefinementRationale { background-color: #fff7ed; border: 1px solid #fed7aa; color: #c2410c; }
        .ai-analysis-section h4 { font-semibold: true; margin-bottom: 0.5rem; }
        .ai-analysis-section p { margin-bottom: 0.25rem; }

        .custom-table th, .custom-table td {
            padding-left: 0.75rem; 
            padding-right: 0.75rem;
            padding-top: 0.5rem; 
            padding-bottom: 0.5rem; 
            vertical-align: middle; 
        }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-gray-800 text-white p-4 shadow-md">
        <div class="container mx-auto max-w-6xl text-center md:text-left">
            <h1 class="text-3xl font-bold text-blue-400">AlloCate</h1>
            <p class="text-sm text-gray-300">Smart ETF Allocation, Simplified.</p>
        </div>
    </header>

    <section id="videoIntroduction" class="container mx-auto max-w-4xl p-4 md:p-6 text-center">
        <h2 class="text-2xl font-semibold mb-4 text-gray-700">Discover AlloCate in Action</h2>
        <div class="video-container bg-white p-2 rounded-lg shadow-lg inline-block">
            <video id="introVideo" muted controls class="w-full rounded-md">
                <source src="https://sahilyfs.github.io/allocate/AlloCate_Branding_Video_Prompt.mp4" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const vid = document.getElementById('introVideo');
                    if (vid) { 
                        vid.addEventListener('loadeddata', function() {
                            vid.pause();
                            vid.currentTime = 0; 
                        });
                    }
                });
            </script>
        </div>
        <p class="mt-3 text-sm text-gray-600">Learn how AlloCate can help you design and optimize your ETF portfolio.</p>
    </section>

    <main class="container mx-auto max-w-6xl p-4 md:p-6">
        <section id="userInputSection" class="card">
            <h2 class="text-xl font-semibold mb-4">1. Define Your Desired Portfolio</h2>
            
            <div class="mb-6">
                <label for="investmentAmount" class="block text-lg font-medium mb-2">Total Investment Amount ($):</label>
                <input type="number" id="investmentAmount" value="100000" class="w-full md:w-1/2 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="e.g., 100000">
            </div>

            <div id="aiProfileRefinementSection" class="card ai-profile-refinement-card mb-6">
                <h3 class="text-lg font-medium mb-2 text-orange-800">✨ AI-Assisted Profile Refinement</h3>
                <p class="text-sm text-orange-700 mb-1">
                    Start by describing your investment focus or theme below. The AI will adjust a balanced profile.
                    <span id="baseProfileInfo" class="hidden">Or, refine the selected "<span id="selectedBaseProfileName" class="font-semibold"></span>" profile.</span>
                </p>
                <p class="text-sm text-orange-700 mb-3"> (e.g., "more focus on renewable energy", "cautious about tech sector", "higher exposure to Asia Pacific developed markets").</p>
                <textarea id="aiProfileRefinementInput" rows="3" class="w-full p-2 border border-orange-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500 text-sm" placeholder="Type your focus here..."></textarea>
                <button id="refineProfileWithAiBtn" class="mt-3 w-full bg-orange-500 hover:bg-orange-600 text-white font-medium py-2 px-4 rounded-md transition duration-150">
                    Refine with AI
                </button>
                <div id="aiProfileRefinementLoading" class="hidden text-center py-3">
                    <div class="pulsing-dots inline-block"><span></span><span></span><span></span></div>
                    <p class="mt-1 text-xs text-orange-700">AI is refining the profile...</p>
                </div>
                <p id="aiProfileRefinementError" class="text-red-500 text-sm mt-2"></p>
                <div id="aiProfileRefinementRationale" class="hidden"></div>
            </div>
            
            <div class="mb-6">
                <h3 class="text-lg font-medium mb-2">Or, Start with a Ready-Made Profile:</h3>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                    <button data-profile="vdco" class="profile-btn bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-150">Conservative</button>
                    <button data-profile="vdba" class="profile-btn bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-150">Balanced</button>
                    <button data-profile="vdgr" class="profile-btn bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-150">Growth</button>
                    <button data-profile="vdhg" class="profile-btn bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-150">High Growth</button>
                </div>
            </div>

            <div id="sectorInputsContainer" class="mb-6">
                <h3 class="text-lg font-medium mb-2">Desired Sector Exposure (%):</h3>
                <div id="sectorInputs" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3"></div>
                <p class="mt-2 font-semibold text-right">Total Sector Allocation: <span id="totalSectorAllocation">0</span>%</p>
                <p id="sectorError" class="text-red-500 text-sm mt-1 text-right"></p>
            </div>
            <div id="geoInputsContainer" class="mb-6">
                <h3 class="text-lg font-medium mb-2">Desired Geographic Exposure (%):</h3>
                <div id="geoInputs" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3"></div>
                <p class="mt-2 font-semibold text-right">Total Geographic Allocation: <span id="totalGeoAllocation">0</span>%</p>
                <p id="geoError" class="text-red-500 text-sm mt-1 text-right"></p>
            </div>
            <button id="generatePortfolioBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-md transition duration-150 text-lg">
                Optimize My Allocation
            </button>
            <p id="formErrorMessage" class="text-red-600 text-center mt-3 text-sm"></p>
        </section>

        <section id="resultsSection" class="hidden mt-8">
            <h2 class="text-xl font-semibold mb-4">2. Your Optimized Portfolio</h2>
            <div id="loadingIndicator" class="hidden text-center py-8"><div class="inline-block animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-500"></div><p class="mt-3 text-lg font-medium">Optimizing your allocation...</p></div>
            <div id="noSolutionMessage" class="hidden card bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert"><p class="font-bold">No Suitable Portfolio Found</p><p>Adjust exposures or try again.</p></div>
            <div id="portfolioIndicators" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="card indicator-card">
                    <div class="indicator-header cursor-pointer flex justify-between items-center">
                        <div>
                            <h4 class="text-sm text-gray-500">Illustrative 1-Yr Return</h4>
                            <p id="indicatorReturn" class="text-2xl font-bold">-%</p>
                        </div>
                        <svg class="arrow-icon w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="details-content">
                        <p class="text-sm text-gray-600 mb-2">Weighted avg 1-yr returns.</p>
                        <ul id="returnDetailsList" class="text-xs text-gray-500 space-y-1 details-list"></ul>
                    </div>
                </div>
                <div class="card indicator-card">
                    <div class="indicator-header cursor-pointer flex justify-between items-center">
                        <div>
                            <h4 class="text-sm text-gray-500">Avg. Expense Ratio</h4>
                            <p id="indicatorExpense" class="text-2xl font-bold">-%</p>
                        </div>
                        <svg class="arrow-icon w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="details-content">
                        <p class="text-sm text-gray-600 mb-2">Weighted avg expense ratios.</p>
                        <ul id="expenseDetailsList" class="text-xs text-gray-500 space-y-1 details-list"></ul>
                    </div>
                </div>
                <div class="card indicator-card">
                    <div class="indicator-header cursor-pointer flex justify-between items-center">
                        <div>
                            <h4 class="text-sm text-gray-500">Sector Match Quality</h4>
                            <p id="indicatorSectorMatch" class="text-2xl font-bold">-</p>
                            <p id="indicatorSectorMatchDesc" class="text-xs text-gray-500">-</p>
                        </div>
                        <svg class="arrow-icon w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="details-content">
                        <p class="text-sm text-gray-600 mb-1">Score: <code class="text-xs">100 - Eff. Avg. Dev.</code></p>
                        <p class="text-sm text-gray-600 mb-2">Eff. Avg. Dev. (Sectors): <span id="sectorEffectiveAvgDeviation" class="font-medium">-</span>% 
                            <span class="tooltip">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline-block ml-1 text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" /></svg>
                                <span class="tooltiptext">(Σ|Actual% - Target%|) / 2</span>
                            </span>
                        </p>
                        <h5 class="text-xs font-semibold text-gray-700 mb-1">Individual Deviations:</h5>
                        <ul id="sectorDeviationsList" class="text-xs text-gray-500 space-y-1 details-list"></ul>
                    </div>
                </div>
                <div class="card indicator-card">
                    <div class="indicator-header cursor-pointer flex justify-between items-center">
                        <div>
                            <h4 class="text-sm text-gray-500">Geo. Match Quality</h4>
                            <p id="indicatorGeoMatch" class="text-2xl font-bold">-</p>
                            <p id="indicatorGeoMatchDesc" class="text-xs text-gray-500">-</p>
                        </div>
                        <svg class="arrow-icon w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="details-content">
                        <p class="text-sm text-gray-600 mb-1">Score: <code class="text-xs">100 - Eff. Avg. Dev.</code></p>
                        <p class="text-sm text-gray-600 mb-2">Eff. Avg. Dev. (Geo.): <span id="geoEffectiveAvgDeviation" class="font-medium">-</span>% 
                            <span class="tooltip">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline-block ml-1 text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" /></svg>
                                <span class="tooltiptext">(Σ|Actual% - Target%|) / 2</span>
                            </span>
                        </p>
                        <h5 class="text-xs font-semibold text-gray-700 mb-1">Individual Deviations:</h5>
                        <ul id="geoDeviationsList" class="text-xs text-gray-500 space-y-1 details-list"></ul>
                    </div>
                </div>
            </div>

            <div id="etfCompositionSection" class="card">
                <h3 class="text-lg font-semibold mb-3">ETF Composition</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 custom-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ETF Name</th>
                                <th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ticker</th>
                                <th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">$ Amount</th>
                                <th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Weight (%)</th>
                            </tr>
                        </thead>
                        <tbody id="etfCompositionTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
                <p class="mt-3 font-semibold">Total Weight: <span id="totalCompositionWeight">0</span>%</p>
                <p id="compositionError" class="text-red-500 text-sm mt-1"></p>
                <div class="flex flex-col sm:flex-row gap-2 mt-4">
                    <button id="recalculateInsightsBtn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition duration-150 flex-grow">Recalculate Portfolio Insights</button>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 mt-3">
                    <button id="getAiInsightsBtn" class="bg-sky-500 hover:bg-sky-600 text-white font-medium py-2 px-4 rounded-md transition duration-150 flex-grow">✨ Get AI Commentary</button>
                    <button id="getDiversificationSuggestionsBtn" class="bg-teal-500 hover:bg-teal-600 text-white font-medium py-2 px-4 rounded-md transition duration-150 flex-grow">✨ Suggest Diversification ETFs</button>
                </div>
                 <div class="mt-3">
                     <button id="getDifferenceAnalysisBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-2 px-4 rounded-md transition duration-150 w-full sm:w-auto">✨ Analyze Allocation Differences</button>
                </div>
            </div>

            <div id="aiInsightsCard" class="card ai-feature-card ai-insights-card hidden mt-6">
                <h3 class="text-lg font-semibold mb-2 text-sky-800">✨ AI Portfolio Commentary</h3>
                <div id="aiInsightsLoading" class="hidden text-center py-4">
                    <div class="pulsing-dots inline-block"><span></span><span></span><span></span></div>
                    <p class="mt-2 text-sm text-sky-700">Generating commentary...</p>
                </div>
                <p id="aiInsightsContent" class="text-sm text-gray-700 leading-relaxed"></p>
                <p id="aiInsightsError" class="text-sm text-red-600"></p>
            </div>

            <div id="diversificationSuggestionsCard" class="card ai-feature-card diversification-suggestions-card hidden mt-6">
                <h3 class="text-lg font-semibold mb-2 text-teal-800">✨ AI Diversification Suggestions</h3>
                <div id="diversificationLoading" class="hidden text-center py-4">
                    <div class="pulsing-dots inline-block"><span></span><span></span><span></span></div>
                    <p class="mt-2 text-sm text-teal-700">Generating diversification ideas...</p>
                </div>
                <div id="diversificationSuggestionsContent" class="text-sm text-gray-700 leading-relaxed">
                    </div>
                <p id="diversificationSuggestionsError" class="text-sm text-red-600"></p>
            </div>
            
            <div id="aiDifferenceAnalysisCard" class="card ai-feature-card ai-difference-analysis-card hidden mt-6">
                <h3 class="text-lg font-semibold mb-2 text-purple-800">✨ AI Analysis of Allocation Differences</h3>
                <div id="aiDifferenceAnalysisLoading" class="hidden text-center py-4">
                    <div class="pulsing-dots inline-block"><span></span><span></span><span></span></div>
                    <p class="mt-2 text-sm text-purple-700">Analyzing differences with Gemini...</p>
                </div>
                <div id="aiDifferenceAnalysisContent">
                    <div class="ai-analysis-section mb-4">
                        <h4 class="text-md font-semibold text-purple-700">Sector Allocation Differences:</h4>
                        <p id="sectorDifferenceExplanation" class="text-sm text-gray-700 leading-relaxed"></p>
                        <p id="sectorDifferenceSuggestions" class="mt-1 text-sm text-gray-600 italic"></p>
                    </div>
                    <hr class="my-3 border-purple-300">
                    <div class="ai-analysis-section">
                        <h4 class="text-md font-semibold text-purple-700">Geographic Allocation Differences:</h4>
                        <p id="geographicDifferenceExplanation" class="text-sm text-gray-700 leading-relaxed"></p>
                        <p id="geographicDifferenceSuggestions" class="mt-1 text-sm text-gray-600 italic"></p>
                    </div>
                </div>
                <p id="aiDifferenceAnalysisError" class="text-sm text-red-600 mt-2"></p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                <div class="card">
                    <h3 class="text-lg font-semibold mb-3">Sector Exposure Comparison</h3>
                    <div class="overflow-x-auto max-h-96">
                        <table class="min-w-full divide-y divide-gray-200 text-sm custom-table">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Sector</th>
                                    <th class="text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Desired (%)</th>
                                    <th class="text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actual (%)</th>
                                    <th class="text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Difference (%)</th>
                                </tr>
                            </thead>
                            <tbody id="sectorComparisonTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div class="mt-4" style="height: 250px;"><canvas id="sectorDoughnutChart"></canvas></div>
                </div>
                <div class="card">
                    <h3 class="text-lg font-semibold mb-3">Geographic Exposure Comparison</h3>
                    <div class="overflow-x-auto max-h-96">
                        <table class="min-w-full divide-y divide-gray-200 text-sm custom-table">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Geography</th>
                                    <th class="text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Desired (%)</th>
                                    <th class="text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actual (%)</th>
                                    <th class="text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Difference (%)</th>
                                </tr>
                            </thead>
                            <tbody id="geoComparisonTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div class="mt-4" style="height: 250px;"><canvas id="geoDoughnutChart"></canvas></div>
                </div>
            </div>
        </section>
    </main>

    <footer class="text-center py-6 text-sm text-gray-500">
        <p>&copy; <span id="currentYear"></span> AlloCate. Illustrative purposes only.</p>
    </footer>

<script>
    // --- CONFIGURATION CONSTANTS ---
    const CONFIG = { 
        SECTORS: ['Information Technology', 'Health Care', 'Financials', 'Consumer Discretionary', 'Communication Services', 'Industrials', 'Consumer Staples', 'Energy', 'Utilities', 'Real Estate', 'Materials'],
        GEOGRAPHIES: ['North America', 'Europe (Developed)', 'Asia Pacific (Developed)', 'Emerging Markets'],
        DEFAULT_AI_BASE_PROFILE: { 
            name: "Default Balanced",
            sectors: { 
                'Information Technology': 18, 'Health Care': 14, 'Financials': 15, 'Consumer Discretionary': 11, 
                'Communication Services': 8, 'Industrials': 10, 'Consumer Staples': 8, 'Energy': 6, 
                'Utilities': 4, 'Real Estate': 3, 'Materials': 3 
            },
            geographies: {
                'North America': 40, 'Europe (Developed)': 20, 'Asia Pacific (Developed)': 30, 'Emerging Markets': 10
            }
        },
        READY_MADE_PORTFOLIOS: { 
            vdco: { 
                name: "Conservative", 
                sectors: { 
                    'Information Technology': 10, 'Health Care': 15, 'Financials': 15, 'Consumer Discretionary': 8, 
                    'Communication Services': 7, 'Industrials': 10, 'Consumer Staples': 12, 'Energy': 5, 
                    'Utilities': 8, 'Real Estate': 5, 'Materials': 5 
                },
                geographies: { 
                    'North America': 30, 'Europe (Developed)': 15, 'Asia Pacific (Developed)': 45, 'Emerging Markets': 10 
                } 
            },
            vdba: { 
                name: "Balanced", 
                sectors: { 
                    'Information Technology': 15, 'Health Care': 14, 'Financials': 16, 'Consumer Discretionary': 10, 
                    'Communication Services': 8, 'Industrials': 10, 'Consumer Staples': 8, 'Energy': 6, 
                    'Utilities': 4, 'Real Estate': 4, 'Materials': 5 
                },
                geographies: { 
                    'North America': 40, 'Europe (Developed)': 20, 'Asia Pacific (Developed)': 30, 'Emerging Markets': 10 
                } 
            },
            vdgr: { 
                name: "Growth", 
                sectors: { 
                    'Information Technology': 20, 'Health Care': 15, 'Financials': 14, 'Consumer Discretionary': 12, 
                    'Communication Services': 9, 'Industrials': 9, 'Consumer Staples': 6, 'Energy': 6, 
                    'Utilities': 3, 'Real Estate': 3, 'Materials': 3 
                },
                geographies: { 
                    'North America': 45, 'Europe (Developed)': 15, 'Asia Pacific (Developed)': 25, 'Emerging Markets': 15 
                } 
            },
            vdhg: { 
                name: "High Growth", 
                sectors: { 
                    'Information Technology': 25, 'Health Care': 14, 'Financials': 12, 'Consumer Discretionary': 14, 
                    'Communication Services': 10, 'Industrials': 8, 'Consumer Staples': 4, 'Energy': 5, 
                    'Utilities': 2, 'Real Estate': 3, 'Materials': 3 
                },
                geographies: { 
                    'North America': 50, 'Europe (Developed)': 15, 'Asia Pacific (Developed)': 20, 'Emerging Markets': 15 
                } 
            }
        },
        MAX_ETFS_IN_PORTFOLIO: 3, 
        WEIGHT_STEP: 0.05, 
        CHART_COLORS: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#6366F1', '#0EA5E9', '#FCD34D', '#A78BFA', '#2DD4BF'],
        CHART_FILTER_THRESHOLD: 0.001 
    };

    const RAW_VANGUARD_ETFS = [ 
        { name: "Vanguard Aus Shares Index ETF", ticker: "VAS", expenseRatio: 0.0007, y1_return: 0.085, sectors: { 'Financials': 0.30, 'Materials': 0.20, 'Health Care': 0.10, 'Industrials': 0.08, 'Consumer Discretionary': 0.07, 'Real Estate': 0.07, 'Energy': 0.05, 'Utilities': 0.04, 'Communication Services': 0.03, 'Information Technology': 0.03, 'Consumer Staples': 0.03 }, geographies: { 'North America': 0, 'Europe (Developed)': 0, 'Asia Pacific (Developed)': 1.0, 'Emerging Markets': 0 } },
        { name: "Vanguard Intl Shares Index ETF", ticker: "VGS", expenseRatio: 0.0018, y1_return: 0.122, sectors: { 'Information Technology': 0.25, 'Financials': 0.15, 'Health Care': 0.13, 'Industrials': 0.10, 'Consumer Discretionary': 0.12, 'Communication Services': 0.08, 'Consumer Staples': 0.07, 'Materials': 0.04, 'Energy': 0.03, 'Utilities': 0.02, 'Real Estate': 0.01 }, geographies: { 'North America': 0.70, 'Europe (Developed)': 0.20, 'Asia Pacific (Developed)': 0.10, 'Emerging Markets': 0 } },
        { name: "Vanguard Emerging Mkts ETF", ticker: "VGE", expenseRatio: 0.0048, y1_return: 0.051, sectors: { 'Financials': 0.22, 'Information Technology': 0.20, 'Consumer Discretionary': 0.15, 'Communication Services': 0.10, 'Materials': 0.08, 'Industrials': 0.07, 'Energy': 0.06, 'Consumer Staples': 0.05, 'Health Care': 0.04, 'Utilities': 0.02, 'Real Estate': 0.01 }, geographies: { 'North America': 0, 'Europe (Developed)': 0, 'Asia Pacific (Developed)': 0.15, 'Emerging Markets': 0.85 } },
        { name: "Vanguard Info Tech ETF", ticker: "VGT", expenseRatio: 0.0010, y1_return: 0.255, sectors: { 'Information Technology': 0.85, 'Communication Services': 0.10, 'Industrials': 0.03, 'Financials': 0.02 }, geographies: { 'North America': 0.95, 'Europe (Developed)': 0.03, 'Asia Pacific (Developed)': 0.02 } }, 
        { name: "Vanguard Health Care ETF", ticker: "VHT", expenseRatio: 0.0010, y1_return: 0.098, sectors: { 'Health Care': 0.90, 'Information Technology': 0.05, 'Industrials': 0.03, 'Financials': 0.02 }, geographies: { 'North America': 0.96, 'Europe (Developed)': 0.02, 'Asia Pacific (Developed)': 0.01, 'Emerging Markets': 0.01 } },
        { name: "Vanguard Global Value ETF", ticker: "VVLU", expenseRatio: 0.0022, y1_return: 0.115, sectors: { 'Financials': 0.25, 'Health Care': 0.15, 'Industrials': 0.12, 'Energy': 0.10, 'Consumer Staples': 0.09, 'Utilities': 0.08, 'Information Technology': 0.07, 'Materials': 0.06, 'Communication Services': 0.04, 'Consumer Discretionary': 0.03, 'Real Estate': 0.01}, geographies: { 'North America': 0.50, 'Europe (Developed)': 0.30, 'Asia Pacific (Developed)': 0.15, 'Emerging Markets': 0.05 } }
    ];

    let vanguardETFs = [], originalTargetSectors = {}, originalTargetGeographies = {}, currentPortfolio = null, sectorChartInstance = null, geoChartInstance = null;
    let selectedBaseProfileKey = null; 

    const domElements = {
        profileButtons: null, 
        investmentAmountInput: document.getElementById('investmentAmount'), 
        sectorInputsContainer: document.getElementById('sectorInputsContainer'), 
        sectorInputsDiv: document.getElementById('sectorInputs'),
        totalSectorAllocationSpan: document.getElementById('totalSectorAllocation'), 
        sectorErrorP: document.getElementById('sectorError'),
        geoInputsContainer: document.getElementById('geoInputsContainer'), 
        geoInputsDiv: document.getElementById('geoInputs'),
        totalGeoAllocationSpan: document.getElementById('totalGeoAllocation'), 
        geoErrorP: document.getElementById('geoError'),
        generatePortfolioBtn: document.getElementById('generatePortfolioBtn'), 
        formErrorMessageP: document.getElementById('formErrorMessage'),
        userInputSection: document.getElementById('userInputSection'), 
        resultsSection: document.getElementById('resultsSection'),
        loadingIndicatorDiv: document.getElementById('loadingIndicator'), 
        noSolutionMessageDiv: document.getElementById('noSolutionMessage'),
        portfolioIndicatorsDiv: document.getElementById('portfolioIndicators'), 
        indicatorReturnP: document.getElementById('indicatorReturn'),
        returnDetailsListUl: document.getElementById('returnDetailsList'), 
        indicatorExpenseP: document.getElementById('indicatorExpense'),
        expenseDetailsListUl: document.getElementById('expenseDetailsList'), 
        indicatorSectorMatchP: document.getElementById('indicatorSectorMatch'),
        indicatorSectorMatchDescP: document.getElementById('indicatorSectorMatchDesc'), 
        sectorEffectiveAvgDeviationSpan: document.getElementById('sectorEffectiveAvgDeviation'),
        sectorDeviationsListUl: document.getElementById('sectorDeviationsList'), 
        indicatorGeoMatchP: document.getElementById('indicatorGeoMatch'),
        indicatorGeoMatchDescP: document.getElementById('indicatorGeoMatchDesc'), 
        geoEffectiveAvgDeviationSpan: document.getElementById('geoEffectiveAvgDeviation'),
        geoDeviationsListUl: document.getElementById('geoDeviationsList'), 
        indicatorCardHeaders: null, 
        etfCompositionSectionDiv: document.getElementById('etfCompositionSection'), 
        etfCompositionTableBody: document.getElementById('etfCompositionTableBody'),
        totalCompositionWeightSpan: document.getElementById('totalCompositionWeight'), 
        compositionErrorP: document.getElementById('compositionError'),
        recalculateInsightsBtn: document.getElementById('recalculateInsightsBtn'), 
        getAiInsightsBtn: document.getElementById('getAiInsightsBtn'),
        getDiversificationSuggestionsBtn: document.getElementById('getDiversificationSuggestionsBtn'), 
        getDifferenceAnalysisBtn: document.getElementById('getDifferenceAnalysisBtn'), 
        aiInsightsCard: document.getElementById('aiInsightsCard'), 
        aiInsightsLoading: document.getElementById('aiInsightsLoading'),
        aiInsightsContent: document.getElementById('aiInsightsContent'), 
        aiInsightsError: document.getElementById('aiInsightsError'),
        diversificationSuggestionsCard: document.getElementById('diversificationSuggestionsCard'), 
        diversificationLoading: document.getElementById('diversificationLoading'), 
        diversificationSuggestionsContent: document.getElementById('diversificationSuggestionsContent'), 
        diversificationSuggestionsError: document.getElementById('diversificationSuggestionsError'), 
        aiDifferenceAnalysisCard: document.getElementById('aiDifferenceAnalysisCard'), 
        aiDifferenceAnalysisLoading: document.getElementById('aiDifferenceAnalysisLoading'), 
        sectorDifferenceExplanation: document.getElementById('sectorDifferenceExplanation'), 
        sectorDifferenceSuggestions: document.getElementById('sectorDifferenceSuggestions'), 
        geographicDifferenceExplanation: document.getElementById('geographicDifferenceExplanation'), 
        geographicDifferenceSuggestions: document.getElementById('geographicDifferenceSuggestions'), 
        aiDifferenceAnalysisError: document.getElementById('aiDifferenceAnalysisError'), 
        sectorComparisonTableBody: document.getElementById('sectorComparisonTableBody'), 
        sectorDoughnutChartCanvas: document.getElementById('sectorDoughnutChart'),
        geoComparisonTableBody: document.getElementById('geoComparisonTableBody'), 
        geoDoughnutChartCanvas: document.getElementById('geoDoughnutChart'),
        currentYearSpan: document.getElementById('currentYear'),
        aiProfileRefinementSection: document.getElementById('aiProfileRefinementSection'),
        baseProfileInfoSpan: document.getElementById('baseProfileInfo'),
        selectedBaseProfileNameSpan: document.getElementById('selectedBaseProfileName'),
        aiProfileRefinementInput: document.getElementById('aiProfileRefinementInput'),
        refineProfileWithAiBtn: document.getElementById('refineProfileWithAiBtn'),
        aiProfileRefinementLoading: document.getElementById('aiProfileRefinementLoading'),
        aiProfileRefinementError: document.getElementById('aiProfileRefinementError'),
        aiProfileRefinementRationale: document.getElementById('aiProfileRefinementRationale'),
    };

    const round = (num, places = 2) => parseFloat(num.toFixed(places));
    const formatPercent = (decimal, places = 2) => `${round(decimal * 100, places)}%`;
    const formatCurrency = (amount) => amount.toLocaleString('en-AU', { style: 'currency', currency: 'AUD', minimumFractionDigits: 0, maximumFractionDigits: 0 });


    function normalizeETFData() { 
        vanguardETFs = RAW_VANGUARD_ETFS.map(etf => {
            const normalizedSectors = {}; CONFIG.SECTORS.forEach(s => normalizedSectors[s] = etf.sectors[s] || 0);
            const normalizedGeographies = {}; CONFIG.GEOGRAPHIES.forEach(g => normalizedGeographies[g] = etf.geographies[g] || 0);
            CONFIG.SECTORS.forEach(s => { if(!(s in normalizedSectors)) normalizedSectors[s] = 0; });
            CONFIG.GEOGRAPHIES.forEach(g => { if(!(g in normalizedGeographies)) normalizedGeographies[g] = 0; });
            return { ...etf, sectors: normalizedSectors, geographies: normalizedGeographies };
        });
    }
    
    function generateInputFields(container, items, type, onUpdateCallback) { 
        container.innerHTML = ''; 
        items.forEach(item => {
            const div = document.createElement('div'); div.className = 'flex items-center justify-between';
            const label = document.createElement('label'); label.htmlFor = `${type}-${item.replace(/\s+/g, '-')}`; label.textContent = `${item}:`; label.className = 'text-sm font-medium text-gray-700 mr-2 whitespace-nowrap';
            const input = document.createElement('input'); input.type = 'number'; input.id = `${type}-${item.replace(/\s+/g, '-')}`; input.name = item; input.min = 0; input.max = 100; input.step = 1; input.className = 'input-field w-24 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm'; 
            input.addEventListener('input', () => {
                onUpdateCallback();
                selectedBaseProfileKey = null; 
                domElements.baseProfileInfoSpan.classList.add('hidden');
                domElements.aiProfileRefinementRationale.classList.add('hidden');
                domElements.aiProfileRefinementRationale.textContent = '';
            });
            div.appendChild(label); div.appendChild(input); container.appendChild(div);
        });
    }
    function updateTotalAllocation(type) { 
        const inputs = domElements[`${type}InputsDiv`].querySelectorAll('input'); let total = 0;
        inputs.forEach(input => total += parseFloat(input.value) || 0);
        domElements[`total${type.charAt(0).toUpperCase() + type.slice(1)}AllocationSpan`].textContent = round(total, 0);
        const errorEl = domElements[`${type}ErrorP`];
        errorEl.textContent = (total !== 0 && total !== 100) ? 'Total must be 100%.' : '';
        return total;
    }
    function populateInputFields(type, values) { 
        const inputs = domElements[`${type}InputsDiv`].querySelectorAll('input');
        inputs.forEach(input => input.value = values[input.name] !== undefined ? round(values[input.name], 0) : '');
        updateTotalAllocation(type);
    }
    function handleReadyMadeProfileClick(event) { 
        selectedBaseProfileKey = event.target.dataset.profile; 
        if (!selectedBaseProfileKey || !CONFIG.READY_MADE_PORTFOLIOS[selectedBaseProfileKey]) return;
        const profile = CONFIG.READY_MADE_PORTFOLIOS[selectedBaseProfileKey];
        if (profile.sectors) { populateInputFields('sector', profile.sectors); } 
        else { populateInputFields('sector', {}); }
        populateInputFields('geo', profile.geographies);
        domElements.selectedBaseProfileNameSpan.textContent = profile.name;
        domElements.baseProfileInfoSpan.classList.remove('hidden');
        domElements.aiProfileRefinementInput.value = ''; 
        domElements.aiProfileRefinementError.textContent = '';
        domElements.aiProfileRefinementRationale.classList.add('hidden');
        domElements.aiProfileRefinementRationale.textContent = '';
        domElements.aiProfileRefinementLoading.classList.add('hidden');
        setTimeout(() => domElements.aiProfileRefinementSection.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
    }
    async function findBestPortfolio(targetSectors, targetGeographies) { 
        return new Promise(resolve => {
            setTimeout(() => { 
                let bestPortfolio = null; let minCombinedError = Infinity; const etfsToConsider = vanguardETFs;
                for (let k = 1; k <= CONFIG.MAX_ETFS_IN_PORTFOLIO; k++) {
                    const combinations = getCombinations(etfsToConsider, k);
                    for (const etfCombination of combinations) {
                        const weightsIterator = generateWeightCombinations(k, CONFIG.WEIGHT_STEP);
                        for (const weights of weightsIterator) {
                            if (weights.reduce((s, w) => s + w, 0) > 1.0001) continue; 
                            const { actualSectors, actualGeographies, sectorSumAbsDiff, geoSumAbsDiff } = calculatePortfolioMetricsInternal(etfCombination, weights, targetSectors, targetGeographies);
                            const combinedError = sectorSumAbsDiff + geoSumAbsDiff;
                            if (combinedError < minCombinedError) {
                                minCombinedError = combinedError;
                                bestPortfolio = { etfs: etfCombination.map((etf, i) => ({ ...etf, weight: weights[i] })), actualSectors, actualGeographies, sectorSumAbsDiff, geoSumAbsDiff, combinedError };
                            }
                        }
                    }
                }
                resolve(bestPortfolio);
            }, 50); 
        });
    }
    function getCombinations(arr, k) { if (k === 0) return [[]]; if (arr.length === 0) return []; const first = arr[0], rest = arr.slice(1); const combsWithoutFirst = getCombinations(rest, k), combsWithFirst = getCombinations(rest, k - 1).map(comb => [first, ...comb]); return [...combsWithFirst, ...combsWithoutFirst]; }
    function* generateWeightCombinations(numEtfs, step) { const numSteps = Math.round(1/step); if (numEtfs===1) yield [1.0]; else if (numEtfs===2) for(let i=0;i<=numSteps;i++){const w1=i*step,w2=1.0-w1;if(w2>=-0.0001)yield [round(w1,4),round(w2,4)];} else if (numEtfs===3) for(let i=0;i<=numSteps;i++){const w1=i*step;for(let j=0;j<=numSteps-i;j++){const w2=j*step,w3=1.0-w1-w2;if(w3>=-0.0001)yield [round(w1,4),round(w2,4),round(w3,4)];}}}
    function calculatePortfolioMetricsInternal(etfSel, weights, targetS, targetG) { const actualS={},actualG={};CONFIG.SECTORS.forEach(s=>actualS[s]=0);CONFIG.GEOGRAPHIES.forEach(g=>actualG[g]=0);etfSel.forEach((etf,idx)=>{const w=weights[idx];CONFIG.SECTORS.forEach(s=>actualS[s]+=(etf.sectors[s]||0)*w);CONFIG.GEOGRAPHIES.forEach(g=>actualG[g]+=(etf.geographies[g]||0)*w);});let sSumAD=0;CONFIG.SECTORS.forEach(s=>sSumAD+=Math.abs(actualS[s]-(targetS[s]||0)));let gSumAD=0;CONFIG.GEOGRAPHIES.forEach(g=>gSumAD+=Math.abs(actualG[g]-(targetG[g]||0)));return{actualSectors:actualS,actualGeographies:actualG,sectorSumAbsDiff:sSumAD,geoSumAbsDiff:gSumAD};}
    function displayLoading(isLoading) { 
        domElements.loadingIndicatorDiv.classList.toggle('hidden',!isLoading);
        domElements.loadingIndicatorDiv.querySelector('p').textContent=isLoading?'Optimizing allocation...':'Optimizing portfolio...';
        if(isLoading){
            domElements.resultsSection.classList.remove('hidden');domElements.noSolutionMessageDiv.classList.add('hidden');
            domElements.portfolioIndicatorsDiv.classList.add('hidden');domElements.etfCompositionSectionDiv.classList.add('hidden');
            domElements.aiInsightsCard.classList.add('hidden');domElements.diversificationSuggestionsCard.classList.add('hidden');
            domElements.aiDifferenceAnalysisCard.classList.add('hidden'); 
            domElements.sectorComparisonTableBody.parentElement.parentElement.parentElement.classList.add('hidden');
            domElements.geoComparisonTableBody.parentElement.parentElement.parentElement.classList.add('hidden');
        }else{
            domElements.portfolioIndicatorsDiv.classList.remove('hidden');domElements.etfCompositionSectionDiv.classList.remove('hidden');
            domElements.sectorComparisonTableBody.parentElement.parentElement.parentElement.classList.remove('hidden');
            domElements.geoComparisonTableBody.parentElement.parentElement.parentElement.classList.remove('hidden');
        }
    }
    function displayNoSolution() { 
        domElements.resultsSection.classList.remove('hidden');domElements.noSolutionMessageDiv.classList.remove('hidden');
        domElements.portfolioIndicatorsDiv.classList.add('hidden');domElements.etfCompositionSectionDiv.classList.add('hidden');
        domElements.aiInsightsCard.classList.add('hidden');domElements.diversificationSuggestionsCard.classList.add('hidden');
        domElements.aiDifferenceAnalysisCard.classList.add('hidden'); 
        domElements.sectorComparisonTableBody.parentElement.parentElement.parentElement.classList.add('hidden');
        domElements.geoComparisonTableBody.parentElement.parentElement.parentElement.classList.add('hidden');
    }
    function getScoreDescription(score) { if(score>=90)return"Excellent";if(score>=80)return"Good";if(score>=70)return"Fair";return"Needs Improvement";}
    
    function updatePortfolioDisplay(portfolioData, targetSectorsPercent, targetGeographiesPercent) {
        const investmentAmount = parseFloat(domElements.investmentAmountInput.value) || 0;

        let weightedReturn = 0, weightedExpense = 0;
        const returnDetails = [], expenseDetails = [];
        portfolioData.etfs.forEach(etf => {
            weightedReturn += etf.y1_return * etf.weight;
            weightedExpense += etf.expenseRatio * etf.weight;
            returnDetails.push(`<li>${etf.ticker}: ${formatPercent(etf.weight)} * ${formatPercent(etf.y1_return)} = ${formatPercent(etf.y1_return * etf.weight, 3)}</li>`);
            expenseDetails.push(`<li>${etf.ticker}: ${formatPercent(etf.weight)} * ${formatPercent(etf.expenseRatio, 4)} = ${formatPercent(etf.expenseRatio * etf.weight, 5)}</li>`);
        });
        domElements.indicatorReturnP.textContent = formatPercent(weightedReturn);
        domElements.returnDetailsListUl.innerHTML = returnDetails.join('');
        domElements.indicatorExpenseP.textContent = formatPercent(weightedExpense, 3);
        domElements.expenseDetailsListUl.innerHTML = expenseDetails.join('');

        const effAvgDevSectors = portfolioData.sectorSumAbsDiff * 100 / 2, sectorScore = Math.max(0, round(100 - effAvgDevSectors));
        domElements.indicatorSectorMatchP.textContent = `${sectorScore}/100`;
        domElements.indicatorSectorMatchDescP.textContent = getScoreDescription(sectorScore);
        domElements.sectorEffectiveAvgDeviationSpan.textContent = round(effAvgDevSectors);
        const sectorDevs = [];
        CONFIG.SECTORS.forEach(s => {
            const actual = (portfolioData.actualSectors[s] || 0) * 100, desired = (targetSectorsPercent[s] || 0), diff = Math.abs(actual - desired);
            if (diff > 0.001) sectorDevs.push(`<li>${s}: ${round(diff)}% dev.</li>`);
        });
        domElements.sectorDeviationsListUl.innerHTML = sectorDevs.length ? sectorDevs.join('') : '<li>No sig. deviations.</li>';

        const effAvgDevGeo = portfolioData.geoSumAbsDiff * 100 / 2, geoScore = Math.max(0, round(100 - effAvgDevGeo));
        domElements.indicatorGeoMatchP.textContent = `${geoScore}/100`;
        domElements.indicatorGeoMatchDescP.textContent = getScoreDescription(geoScore);
        domElements.geoEffectiveAvgDeviationSpan.textContent = round(effAvgDevGeo);
        const geoDevs = [];
        CONFIG.GEOGRAPHIES.forEach(g => {
            const actual = (portfolioData.actualGeographies[g] || 0) * 100, desired = (targetGeographiesPercent[g] || 0), diff = Math.abs(actual - desired);
            if (diff > 0.001) geoDevs.push(`<li>${g}: ${round(diff)}% dev.</li>`);
        });
        domElements.geoDeviationsListUl.innerHTML = geoDevs.length ? geoDevs.join('') : '<li>No sig. deviations.</li>';

        domElements.etfCompositionTableBody.innerHTML = '';
        let totalCompositionWeight = 0;
        portfolioData.etfs.forEach(etf => {
            const row = domElements.etfCompositionTableBody.insertRow();
            
            const nameCell = row.insertCell();
            nameCell.textContent = etf.name;
            nameCell.className = 'text-left';

            const tickerCell = row.insertCell();
            tickerCell.textContent = etf.ticker;
            tickerCell.className = 'text-left';
            
            const dollarAmountCell = row.insertCell();
            const dollarAmount = investmentAmount * etf.weight;
            dollarAmountCell.textContent = formatCurrency(dollarAmount);
            dollarAmountCell.className = 'text-left'; 

            const weightCell = row.insertCell();
            const weightInput = document.createElement('input');
            weightInput.type = 'number';
            weightInput.min = 0; weightInput.max = 100; weightInput.step = 1;
            weightInput.value = round(etf.weight * 100, 0);
            weightInput.dataset.ticker = etf.ticker;
            weightInput.className = 'etf-weight-input w-20 p-1 border border-gray-300 rounded-md text-sm text-center'; 
            weightCell.appendChild(weightInput);
            weightCell.className = 'text-left'; 

            totalCompositionWeight += etf.weight * 100;
        });
        domElements.totalCompositionWeightSpan.textContent = round(totalCompositionWeight, 0);
        updateTotalCompositionWeight();

        updateComparisonTable(domElements.sectorComparisonTableBody, CONFIG.SECTORS, targetSectorsPercent, portfolioData.actualSectors, true);
        updateComparisonTable(domElements.geoComparisonTableBody, CONFIG.GEOGRAPHIES, targetGeographiesPercent, portfolioData.actualGeographies, true);
        createOrUpdateDoughnutChart('sector', domElements.sectorDoughnutChartCanvas, CONFIG.SECTORS, portfolioData.actualSectors, 'Actual Sector Allocation');
        createOrUpdateDoughnutChart('geo', domElements.geoDoughnutChartCanvas, CONFIG.GEOGRAPHIES, portfolioData.actualGeographies, 'Actual Geographic Allocation');
        
        domElements.aiInsightsCard.classList.add('hidden');domElements.aiInsightsContent.textContent='';domElements.aiInsightsError.textContent='';domElements.aiInsightsLoading.classList.add('hidden');
        domElements.diversificationSuggestionsCard.classList.add('hidden');domElements.diversificationSuggestionsContent.innerHTML='';domElements.diversificationSuggestionsError.textContent='';domElements.diversificationLoading.classList.add('hidden');
        domElements.aiDifferenceAnalysisCard.classList.add('hidden'); domElements.sectorDifferenceExplanation.textContent=''; domElements.sectorDifferenceSuggestions.textContent=''; domElements.geographicDifferenceExplanation.textContent=''; domElements.geographicDifferenceSuggestions.textContent=''; domElements.aiDifferenceAnalysisError.textContent=''; domElements.aiDifferenceAnalysisLoading.classList.add('hidden');
        
        domElements.resultsSection.classList.remove('hidden');
        domElements.noSolutionMessageDiv.classList.add('hidden');
        domElements.portfolioIndicatorsDiv.classList.remove('hidden');
        domElements.etfCompositionSectionDiv.classList.remove('hidden');
        domElements.sectorComparisonTableBody.parentElement.parentElement.parentElement.classList.remove('hidden');
        domElements.geoComparisonTableBody.parentElement.parentElement.parentElement.classList.remove('hidden');
    }

    function updateComparisonTable(tbody, categories, desiredMapPercent, actualMapDecimal, actualIsDecimal = true) {
        tbody.innerHTML = ''; 
        categories.forEach(category => {
            const desiredValue = desiredMapPercent[category] || 0; 
            const actualValueDecimal = actualMapDecimal[category] || 0; 
            const desiredPercent = desiredValue > 1.5 ? desiredValue : desiredValue * 100; 
            const actualPercent = actualIsDecimal ? actualValueDecimal * 100 : actualValueDecimal;
            const difference = actualPercent - desiredPercent;

            const row = tbody.insertRow();
            
            const categoryCell = row.insertCell();
            categoryCell.textContent = category;
            categoryCell.className = 'text-right'; 

            const desiredCell = row.insertCell();
            desiredCell.textContent = round(desiredPercent);
            desiredCell.className = 'text-right'; 

            const actualCell = row.insertCell();
            actualCell.textContent = round(actualPercent);
            actualCell.className = 'text-right'; 
            
            const diffCell = row.insertCell();
            diffCell.textContent = round(difference);
            diffCell.className = 'text-right'; 
            if (difference < -0.01) diffCell.classList.add('text-red-600'); 
            else if (difference > 0.01) diffCell.classList.add('text-green-600'); 
        });
    }

    function createOrUpdateDoughnutChart(type,canvasEl,allLabels,dataMapDec,title){let chartInst=type==='sector'?sectorChartInstance:geoChartInstance;if(chartInst)chartInst.destroy();const filtLabels=[],filtData=[];allLabels.forEach(lbl=>{const val=dataMapDec[lbl]||0;if(val>=CONFIG.CHART_FILTER_THRESHOLD){filtLabels.push(lbl);filtData.push(round(val*100,2));}});const newCI=new Chart(canvasEl,{type:'doughnut',data:{labels:filtLabels,datasets:[{label:title,data:filtData,backgroundColor:CONFIG.CHART_COLORS,borderColor:'#fff',borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:10},boxWidth:15,padding:10}},title:{display:true,text:title,font:{size:14,weight:'normal'}},tooltip:{callbacks:{label:ctx=>{let lbl=ctx.label||'';if(lbl)lbl+=': ';if(ctx.parsed!==null)lbl+=ctx.parsed+'%';return lbl;}}}}}});if(type==='sector')sectorChartInstance=newCI;else geoChartInstance=newCI;}
    
    async function handleGeneratePortfolio() {
        domElements.formErrorMessageP.textContent = '';
        // domElements.aiProfileRefinementSection.classList.add('hidden'); // This line is commented out
        selectedBaseProfileKey = null;
        if (updateTotalAllocation('sector') !== 100 || updateTotalAllocation('geo') !== 100) { 
            domElements.formErrorMessageP.textContent = 'Total sector and geographic allocations must each be 100%.'; 
            domElements.userInputSection.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
            return; 
        }
        displayLoading(true); 
        domElements.resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        originalTargetSectors = {}; 
        domElements.sectorInputsDiv.querySelectorAll('input').forEach(i => originalTargetSectors[i.name] = (parseFloat(i.value)||0)/100);
        originalTargetGeographies = {}; 
        domElements.geoInputsDiv.querySelectorAll('input').forEach(i => originalTargetGeographies[i.name] = (parseFloat(i.value)||0)/100);
        
        currentPortfolio = await findBestPortfolio(originalTargetSectors, originalTargetGeographies); 
        displayLoading(false);
        
        if (currentPortfolio && currentPortfolio.etfs && currentPortfolio.etfs.length > 0) {
            const origTSPerc = {}, origTGPerc = {};
            for (const k in originalTargetSectors) origTSPerc[k] = originalTargetSectors[k]*100;
            for (const k in originalTargetGeographies) origTGPerc[k] = originalTargetGeographies[k]*100;
            updatePortfolioDisplay(currentPortfolio, origTSPerc, origTGPerc);
        } else {
            displayNoSolution();
        }
    }

    function updateTotalCompositionWeight() {
        const inputs = domElements.etfCompositionTableBody.querySelectorAll('.etf-weight-input');
        let total = 0;
        inputs.forEach(i => total += parseFloat(i.value) || 0);
        domElements.totalCompositionWeightSpan.textContent = round(total, 0);
        domElements.compositionErrorP.textContent = (total !== 100 && total !== 0) ? 'Total weight must be 100% to recalculate.' : '';
        
        if (currentPortfolio && currentPortfolio.etfs) {
            const investmentAmount = parseFloat(domElements.investmentAmountInput.value) || 0;
            const rows = domElements.etfCompositionTableBody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                if (currentPortfolio.etfs[index]) {
                    const weightInput = row.querySelector('.etf-weight-input');
                    const weightPercent = parseFloat(weightInput.value) || 0;
                    const dollarAmount = investmentAmount * (weightPercent / 100);
                    if(row.cells[2]) { 
                         row.cells[2].textContent = formatCurrency(dollarAmount);
                         row.cells[2].className = 'text-left'; 
                    }
                }
            });
        }
        return total;
    }

    function handleRecalculatePortfolioInsights() {
        if(!currentPortfolio||!currentPortfolio.etfs||currentPortfolio.etfs.length===0){domElements.compositionErrorP.textContent='No portfolio to recalculate.';return;}
        const inputs=domElements.etfCompositionTableBody.querySelectorAll('.etf-weight-input');
        let newTotalWPerc=0;const newWeightsDec=[],etfDataRecalc=[];
        const currentEtfTickers=currentPortfolio.etfs.map(e=>e.ticker);
        currentEtfTickers.forEach(ticker=>{
            const etfFD=vanguardETFs.find(e=>e.ticker===ticker);
            if(!etfFD){console.error(`Data for ${ticker} missing.`);domElements.compositionErrorP.textContent=`Err: ${ticker} data missing.`;return;}
            const inputF=Array.from(inputs).find(inp=>inp.dataset.ticker===ticker);
            if(!inputF){console.error(`Weight for ${ticker} missing.`);domElements.compositionErrorP.textContent=`Err: ${ticker} weight missing.`;return;}
            const wPerc=parseFloat(inputF.value)||0;
            newTotalWPerc+=wPerc;
            newWeightsDec.push(wPerc/100);
            etfDataRecalc.push({...etfFD});
        });
        if(Math.abs(newTotalWPerc-100)>0.1){domElements.compositionErrorP.textContent='Total weight must be 100%.';return;}
        domElements.compositionErrorP.textContent='';
        const{actualSectors,actualGeographies,sectorSumAbsDiff,geoSumAbsDiff}=calculatePortfolioMetricsInternal(etfDataRecalc,newWeightsDec,originalTargetSectors,originalTargetGeographies);
        const recalcP={etfs:etfDataRecalc.map((e,i)=>({...e,weight:newWeightsDec[i]})),actualSectors,actualGeographies,sectorSumAbsDiff,geoSumAbsDiff};
        currentPortfolio=recalcP;
        const origTSPerc={},origTGPerc={};
        for(const k in originalTargetSectors)origTSPerc[k]=originalTargetSectors[k]*100;
        for(const k in originalTargetGeographies)origTGPerc[k]=originalTargetGeographies[k]*100;
        updatePortfolioDisplay(recalcP,origTSPerc,origTGPerc); 
        domElements.resultsSection.scrollIntoView({behavior:'smooth',block:'start'});
    }

    function toggleIndicatorDetails(event){const h=event.currentTarget,c=h.nextElementSibling,a=h.querySelector('.arrow-icon');c.classList.toggle('open');a.classList.toggle('rotated');}

    async function handleGetAiInsights() { 
        if(!currentPortfolio||!currentPortfolio.actualSectors||!currentPortfolio.actualGeographies){domElements.aiInsightsError.textContent='Generate/recalculate a portfolio first.';domElements.aiInsightsCard.classList.remove('hidden');domElements.aiInsightsContent.textContent='';domElements.aiInsightsLoading.classList.add('hidden');domElements.diversificationSuggestionsCard.classList.add('hidden');domElements.aiDifferenceAnalysisCard.classList.add('hidden');return;}
        domElements.aiInsightsCard.classList.remove('hidden');domElements.aiInsightsLoading.classList.remove('hidden');domElements.aiInsightsContent.textContent='';domElements.aiInsightsError.textContent='';domElements.diversificationSuggestionsCard.classList.add('hidden');domElements.aiDifferenceAnalysisCard.classList.add('hidden');
        let sDataStr="",gDataStr="";for(const s in currentPortfolio.actualSectors){const p=currentPortfolio.actualSectors[s]*100;if(p>0.1)sDataStr+=`${s}: ${round(p,1)}%, `;}sDataStr=sDataStr.slice(0,-2);for(const g in currentPortfolio.actualGeographies){const p=currentPortfolio.actualGeographies[g]*100;if(p>0.1)gDataStr+=`${g}: ${round(p,1)}%, `;}gDataStr=gDataStr.slice(0,-2);
        const promptTextForGemini=`You are a helpful financial assistant. Based on the following ETF portfolio's actual allocations, provide a brief (2-4 sentences) qualitative commentary. Discuss potential characteristics, strengths, or areas a user might want to consider further. Be balanced and objective. Do not give financial advice or make any specific investment recommendations. Actual Sector Allocations: ${sDataStr||'None significant'}. Actual Geographic Allocations: ${gDataStr||'None significant'}.`;
        const geminiModel = "gemini-2.0-flash";
        const geminiApiPayload = { contents: [{ role: "user", parts: [{ text: promptTextForGemini }] }] };
        const proxyUrl = "/api/geminiProxy";
        try{
            const response = await fetch(proxyUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ model: geminiModel, geminiPayload: geminiApiPayload }) });
            const result = await response.json();
            if(!response.ok){ const errorDetail = result?.error || `Proxy request failed with status ${response.status}`; console.error('Error from proxy for AI insights:', result); throw new Error(errorDetail); }
            if(result.candidates?.[0]?.content?.parts?.[0]?.text) { domElements.aiInsightsContent.textContent = result.candidates[0].content.parts[0].text.trim(); } 
            else { console.error('Unexpected data structure from proxy/Gemini (Insights):', result); throw new Error('Could not extract insights from API response via proxy.'); }
        }catch(error){ console.error('Error fetching AI insights (via proxy):',error); const displayMessage = error instanceof Error && error.message ? error.message : String(error); domElements.aiInsightsError.textContent=`Failed to load AI insights. ${displayMessage || 'An unexpected error occurred.'} Try again.`; domElements.aiInsightsContent.textContent='';
        }finally{domElements.aiInsightsLoading.classList.add('hidden');domElements.aiInsightsCard.scrollIntoView({behavior:'smooth',block:'nearest'});}
    }

    async function handleGetDiversificationSuggestions() { 
        if(!currentPortfolio||!currentPortfolio.etfs){domElements.diversificationSuggestionsError.textContent='Generate/recalculate a portfolio first.';domElements.diversificationSuggestionsCard.classList.remove('hidden');domElements.diversificationSuggestionsContent.innerHTML='';domElements.diversificationLoading.classList.add('hidden');domElements.aiInsightsCard.classList.add('hidden');domElements.aiDifferenceAnalysisCard.classList.add('hidden');return;}
        domElements.diversificationSuggestionsCard.classList.remove('hidden');domElements.diversificationLoading.classList.remove('hidden');domElements.diversificationSuggestionsContent.innerHTML='';domElements.diversificationSuggestionsError.textContent='';domElements.aiInsightsCard.classList.add('hidden');domElements.aiDifferenceAnalysisCard.classList.add('hidden');
        const currentEtfTickers=currentPortfolio.etfs.map(etf=>etf.ticker);const availableETFsForSuggestion=RAW_VANGUARD_ETFS.filter(etf=>!currentEtfTickers.includes(etf.ticker)).map(etf=>({ticker:etf.ticker,name:etf.name}));
        if(availableETFsForSuggestion.length===0){domElements.diversificationSuggestionsContent.innerHTML='<p>All available ETFs are already in your portfolio or no other ETFs are available for suggestion.</p>';domElements.diversificationLoading.classList.add('hidden');return;}
        let sDataStr="",gDataStr="";for(const s in currentPortfolio.actualSectors){const p=currentPortfolio.actualSectors[s]*100;if(p>0.1)sDataStr+=`${s}: ${round(p,1)}%, `;}sDataStr=sDataStr.slice(0,-2);for(const g in currentPortfolio.actualGeographies){const p=currentPortfolio.actualGeographies[g]*100;if(p>0.1)gDataStr+=`${g}: ${round(p,1)}%, `;}gDataStr=gDataStr.slice(0,-2);const currentPortfolioETFsString=currentPortfolio.etfs.map(e=>`${e.name} (${e.ticker})`).join(', ');
        const promptTextForGemini=`You are a helpful financial assistant. Current portfolio consists of: ${currentPortfolioETFsString}. Current portfolio actual sector allocations: ${sDataStr||'None significant'}. Current portfolio actual geographic allocations: ${gDataStr||'None significant'}. Available ETFs to suggest from (provide ticker and name): ${JSON.stringify(availableETFsForSuggestion)}. Based on this, suggest 1 or 2 additional ETFs from the 'Available ETFs' list that could enhance diversification for the current portfolio. For each suggestion, provide its ticker, name, and a detailed (3-4 sentences) rationale. This rationale should clearly explain how the suggested ETF would enhance diversification, specifically mentioning which underrepresented sectors or geographies it covers, or what different investment style or market cap it introduces, and how it complements the existing portfolio's exposures. Do not suggest ETFs already in the current portfolio. Do not give financial advice or make any specific investment recommendations. Ensure your response is in the specified JSON format.`;
        const schema={type:"ARRAY",items:{type:"OBJECT",properties:{"ticker":{"type":"STRING"},"name":{"type":"STRING"},"rationale":{"type":"STRING"}},required:["ticker","name","rationale"]}};
        const geminiModel = "gemini-2.0-flash";
        const geminiApiPayload = { contents: [{ role: "user", parts: [{ text: promptTextForGemini }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } };
        const proxyUrl = "/api/geminiProxy";
        try{
            const response = await fetch(proxyUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ model: geminiModel, geminiPayload: geminiApiPayload }) });
            const result = await response.json();
            if(!response.ok){ const errorDetail = result?.error || `Proxy request failed with status ${response.status}`; console.error('Error from proxy for diversification suggestions:', result); throw new Error(errorDetail); }
            if(result.candidates?.[0]?.content?.parts?.[0]?.text){
                const suggestions=JSON.parse(result.candidates[0].content.parts[0].text);
                if(suggestions&&suggestions.length>0){ let html='<ul class="space-y-3">'; suggestions.forEach(sugg=>{html+=`<li class="p-3 border border-teal-300 rounded-md bg-teal-50 shadow-sm"><p class="font-semibold text-teal-700">${sugg.name} (${sugg.ticker})</p><p class="mt-1 text-xs text-teal-600">${sugg.rationale}</p></li>`;}); html+='</ul>'; domElements.diversificationSuggestionsContent.innerHTML=html;
                } else { domElements.diversificationSuggestionsContent.innerHTML='<p>No specific diversification suggestions could be generated at this time, or the AI determined the portfolio is already well-diversified with the available options.</p>'; }
            } else { console.error('Unexpected data structure from proxy/Gemini (Diversification):',result); throw new Error('Could not extract diversification suggestions from API response via proxy.'); }
        }catch(error){ console.error('Error fetching diversification suggestions (via proxy):',error); const displayMessage = error instanceof Error && error.message ? error.message : String(error); domElements.diversificationSuggestionsError.textContent=`Failed to load suggestions. ${displayMessage || 'An unexpected error occurred.'} Try again.`; domElements.diversificationSuggestionsContent.innerHTML='';
        }finally{domElements.diversificationLoading.classList.add('hidden');domElements.diversificationSuggestionsCard.scrollIntoView({behavior:'smooth',block:'nearest'});}}

    async function handleRefineProfileWithAi() {
        const userFocus = domElements.aiProfileRefinementInput.value.trim();
        
        if (!userFocus && !selectedBaseProfileKey) { 
            domElements.aiProfileRefinementError.textContent = "Please describe your investment focus or select a base profile to refine.";
            domElements.aiProfileRefinementRationale.classList.add('hidden');
            return;
        }
        if (!userFocus && selectedBaseProfileKey){ 
            domElements.aiProfileRefinementError.textContent = "Please describe how you'd like to refine the selected profile.";
            domElements.aiProfileRefinementRationale.classList.add('hidden');
            return;
        }

        domElements.aiProfileRefinementLoading.classList.remove('hidden');
        domElements.aiProfileRefinementError.textContent = ''; 
        domElements.aiProfileRefinementRationale.classList.add('hidden');
        domElements.aiProfileRefinementRationale.textContent = '';
        
        let baseProfileName, baseSectorsObj, baseGeosObj;
        if (selectedBaseProfileKey && CONFIG.READY_MADE_PORTFOLIOS[selectedBaseProfileKey]) {
            const profile = CONFIG.READY_MADE_PORTFOLIOS[selectedBaseProfileKey];
            baseProfileName = profile.name;
            baseSectorsObj = { ...(profile.sectors || CONFIG.DEFAULT_AI_BASE_PROFILE.sectors) };
            baseGeosObj = { ...(profile.geographies || CONFIG.DEFAULT_AI_BASE_PROFILE.geographies) };
        } else { 
            baseProfileName = CONFIG.DEFAULT_AI_BASE_PROFILE.name;
            baseSectorsObj = { ...CONFIG.DEFAULT_AI_BASE_PROFILE.sectors };
            baseGeosObj = { ...CONFIG.DEFAULT_AI_BASE_PROFILE.geographies };
            domElements.selectedBaseProfileNameSpan.textContent = baseProfileName; 
            domElements.baseProfileInfoSpan.classList.remove('hidden');
        }
        let baseSectorsString = ""; Object.entries(baseSectorsObj).forEach(([s,v]) => baseSectorsString += `${s}: ${v}%, `); baseSectorsString = baseSectorsString.slice(0, -2);
        let baseGeosString = ""; Object.entries(baseGeosObj).forEach(([g,v]) => baseGeosString += `${g}: ${v}%, `); baseGeosString = baseGeosString.slice(0, -2);
        
        const MAX_RETRIES = 2; 

        async function attemptApiCallAndRefine(attemptNumber, previousFailureData = null) {
            let promptTextForGemini;
            let currentLoadingMessage = `AI is refining the profile (Attempt ${attemptNumber + 1}/${MAX_RETRIES + 1})...`;

            if (attemptNumber > 0 && previousFailureData) {
                const { invalidSectors, sumSectorsVal, invalidGeos, sumGeosVal } = previousFailureData;
                promptTextForGemini = `Your previous attempt (Attempt ${attemptNumber}) to refine an investment profile for user focus "${userFocus}" on base profile "${baseProfileName}" (Base Sectors: ${baseSectorsString}, Base Geos: ${baseGeosString}) was invalid.
Your returned sector allocations summed to ${sumSectorsVal}% (details: ${JSON.stringify(invalidSectors)}). This sum MUST be exactly 100%.
Your returned geographic allocations summed to ${sumGeosVal}% (details: ${JSON.stringify(invalidGeos)}). This sum MUST be exactly 100%.
This is critically incorrect. Please correct your response. You MUST adjust the allocations you provide so that the total for sectors is exactly 100% and the total for geographies is exactly 100%. Re-evaluate your previous numbers and make the necessary adjustments to meet these sum requirements precisely. Do not miss any categories.
Provide new adjusted percentage allocations for ALL of the following sectors: ${CONFIG.SECTORS.join(', ')}, and ALL of the following geographies: ${CONFIG.GEOGRAPHIES.join(', ')}.
Also, provide a brief (2-3 sentences) 'refinementRationale' explaining the key adjustments you made based on the original user focus: "${userFocus}".
Return your response in the specified JSON format, adhering to the schema. Ensure all listed sectors and geographies are present in your response, even if their allocation is 0.`;
                domElements.aiProfileRefinementError.textContent = `AI's Attempt ${attemptNumber} was invalid (sums not 100%). Retrying...`; 
                currentLoadingMessage = `AI is re-attempting refinement (Attempt ${attemptNumber + 1}/${MAX_RETRIES + 1})...`;
            } else {
                promptTextForGemini = `You are a helpful financial assistant. The user wants to refine an investment profile. The base profile being considered is "${baseProfileName}" with initial allocations: Base Sector Allocations: ${baseSectorsString}. Base Geographic Allocations: ${baseGeosString}. The user's specific focus or concern is: "${userFocus}". Based on the user's focus, please suggest adjusted percentage allocations for ALL of the following sectors: ${CONFIG.SECTORS.join(', ')}, and ALL of the following geographies: ${CONFIG.GEOGRAPHIES.join(', ')}. Also, provide a brief (2-3 sentences) 'refinementRationale' explaining the key adjustments you made and why, based on the user's focus. The sum of your suggested sector percentages MUST equal 100%. The sum of your suggested geographic percentages MUST equal 100%. Make reasonable adjustments to the base profile. For categories not directly impacted by the user's focus, try to maintain original allocations or adjust minimally to ensure totals sum to 100. Do not give financial advice or specific investment recommendations. Return your response in the specified JSON format. Ensure all listed sectors and geographies are present in your response, even if their allocation is 0.`;
            }
            
            domElements.aiProfileRefinementLoading.querySelector('p').textContent = currentLoadingMessage;

            const sectorProperties = {}; CONFIG.SECTORS.forEach(s => sectorProperties[s] = {"type":"NUMBER"});
            const geoProperties = {}; CONFIG.GEOGRAPHIES.forEach(g => geoProperties[g] = {"type":"NUMBER"});
            const schema = { type: "OBJECT", properties: { "adjustedSectors": { type: "OBJECT", properties: sectorProperties, required: CONFIG.SECTORS }, "adjustedGeographies": { type: "OBJECT", properties: geoProperties, required: CONFIG.GEOGRAPHIES }, "refinementRationale": { "type": "STRING" } }, required: ["adjustedSectors", "adjustedGeographies", "refinementRationale"] };
            const geminiModel = "gemini-2.0-flash";
            const geminiApiPayload = { contents: [{ role: "user", parts: [{ text: promptTextForGemini }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } };
            const proxyUrl = "/api/geminiProxy";

            const response = await fetch(proxyUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ model: geminiModel, geminiPayload: geminiApiPayload }) });
            const result = await response.json();

            if (!response.ok) {
                const errorDetail = result?.error || `Proxy request failed with status ${response.status}`;
                console.error(`Error from proxy for profile refinement (Attempt ${attemptNumber + 1}):`, result);
                throw new Error(errorDetail); 
            }

            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                const refinedData = JSON.parse(result.candidates[0].content.parts[0].text);
                const sumSectorsVal = round(Object.values(refinedData.adjustedSectors).reduce((s,v)=>s+(parseFloat(v)||0),0),0);
                const sumGeosVal = round(Object.values(refinedData.adjustedGeographies).reduce((s,v)=>s+(parseFloat(v)||0),0),0);

                if (sumSectorsVal !== 100 || sumGeosVal !== 100) {
                    if (attemptNumber < MAX_RETRIES) {
                        console.warn(`Attempt ${attemptNumber + 1} failed sum check (Sectors: ${sumSectorsVal}%, Geos: ${sumGeosVal}%). Retrying.`);
                        return await attemptApiCallAndRefine(attemptNumber + 1, { 
                            invalidSectors: refinedData.adjustedSectors, sumSectorsVal,
                            invalidGeos: refinedData.adjustedGeographies, sumGeosVal
                        });
                    } else {
                        throw new Error(`AI returned allocations not summing to 100% after ${MAX_RETRIES + 1} attempts. Last sums - Sectors: ${sumSectorsVal}%, Geos: ${sumGeosVal}%. Please try again or adjust manually.`);
                    }
                }
                domElements.aiProfileRefinementError.textContent = ''; 
                populateInputFields('sector', refinedData.adjustedSectors);
                populateInputFields('geo', refinedData.adjustedGeographies);
                if (refinedData.refinementRationale) { 
                    domElements.aiProfileRefinementRationale.textContent = refinedData.refinementRationale; 
                    domElements.aiProfileRefinementRationale.classList.remove('hidden'); 
                }
                domElements.aiProfileRefinementInput.value = ''; 
                domElements.sectorInputsContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return true; 
            } else { 
                console.error(`Unexpected data structure from proxy/Gemini (Attempt ${attemptNumber + 1}):`, result); 
                throw new Error('Could not extract refined profile from API response via proxy.'); 
            }
        } 

        try {
            await attemptApiCallAndRefine(0); 
        } catch (error) { 
            console.error('Error refining profile with AI (via proxy):', error); 
            const displayMessage = error instanceof Error && error.message ? error.message : String(error);
            domElements.aiProfileRefinementError.textContent = `Failed to refine profile. ${displayMessage || 'An unexpected error occurred.'}`;
        } finally { 
            domElements.aiProfileRefinementLoading.querySelector('p').textContent = "AI is refining the profile..."; 
            domElements.aiProfileRefinementLoading.classList.add('hidden'); 
        }
    }

    async function handleAnalyzeAllocationDifferences() {
        if (!currentPortfolio || !originalTargetSectors || !originalTargetGeographies) {
            domElements.aiDifferenceAnalysisError.textContent = 'Please generate a portfolio first to analyze differences.';
            domElements.aiDifferenceAnalysisCard.classList.remove('hidden'); domElements.sectorDifferenceExplanation.textContent = ''; domElements.sectorDifferenceSuggestions.textContent = ''; domElements.geographicDifferenceExplanation.textContent = ''; domElements.geographicDifferenceSuggestions.textContent = ''; domElements.aiDifferenceAnalysisLoading.classList.add('hidden');
            domElements.aiInsightsCard.classList.add('hidden'); domElements.diversificationSuggestionsCard.classList.add('hidden'); return;
        }
        domElements.aiDifferenceAnalysisCard.classList.remove('hidden'); domElements.aiDifferenceAnalysisLoading.classList.remove('hidden');
        domElements.sectorDifferenceExplanation.textContent = ''; domElements.sectorDifferenceSuggestions.textContent = ''; domElements.geographicDifferenceExplanation.textContent = ''; domElements.geographicDifferenceSuggestions.textContent = ''; domElements.aiDifferenceAnalysisError.textContent = '';
        domElements.aiInsightsCard.classList.add('hidden'); domElements.diversificationSuggestionsCard.classList.add('hidden');
        const desiredSectorsPercent = {}; for (const sector in originalTargetSectors) desiredSectorsPercent[sector] = round(originalTargetSectors[sector] * 100, 1);
        const actualSectorsPercent = {}; for (const sector in currentPortfolio.actualSectors) actualSectorsPercent[sector] = round(currentPortfolio.actualSectors[sector] * 100, 1);
        const desiredGeosPercent = {}; for (const geo in originalTargetGeographies) desiredGeosPercent[geo] = round(originalTargetGeographies[geo] * 100, 1);
        const actualGeosPercent = {}; for (const geo in currentPortfolio.actualGeographies) actualGeosPercent[geo] = round(currentPortfolio.actualGeographies[geo] * 100, 1);
        const currentETFsInPortfolio = currentPortfolio.etfs.map(etf => `${etf.name} (${etf.ticker}) at ${formatPercent(etf.weight)} weight`).join('; ');
        const availableETFsForSuggestion = RAW_VANGUARD_ETFS.filter(etf => !currentPortfolio.etfs.find(pEtf => pEtf.ticker === etf.ticker)).map(etf => ({ ticker: etf.ticker, name: etf.name }));
        const promptTextForGemini = `You are a helpful financial analyst. The user's desired portfolio allocations and the actual allocations of their generated ETF portfolio are provided below. Current ETFs in portfolio: ${currentETFsInPortfolio}. Available ETFs for suggestions (if needed, provide ticker and name): ${JSON.stringify(availableETFsForSuggestion)}. SECTOR ANALYSIS: Desired Sector Allocations: ${JSON.stringify(desiredSectorsPercent)}. Actual Sector Allocations: ${JSON.stringify(actualSectorsPercent)}. Please: 1. Identify the 2-3 most significant differences (over or underweight) between desired and actual sector allocations. 2. Briefly explain potential reasons for these sector differences, considering the ETFs in the current portfolio. 3. Suggest 1-2 actionable steps the user could consider to reduce these sector differences. This might involve adjusting weights of current ETFs or, if a large gap persists, suggesting an alternative ETF from the 'Available ETFs' list that could help (mention its name and ticker). GEOGRAPHIC ANALYSIS: Desired Geographic Allocations: ${JSON.stringify(desiredGeosPercent)}. Actual Geographic Allocations: ${JSON.stringify(actualGeosPercent)}. Please: 1. Identify the 2-3 most significant differences (over or underweight) between desired and actual geographic allocations. 2. Briefly explain potential reasons for these geographic differences, considering the ETFs in the current portfolio. 3. Suggest 1-2 actionable steps the user could consider to reduce these geographic differences. This might involve adjusting weights of current ETFs or, if a large gap persists, suggesting an alternative ETF from the 'Available ETFs' list that could help (mention its name and ticker). IMPORTANT: - Be concise and clear. - Focus on explaining the 'why' behind differences and practical 'how-to' for adjustments. - Acknowledge if perfect alignment might be difficult with the current setup. - Do NOT give financial advice or make specific investment recommendations beyond suggesting alignment strategies. - Return your response in the specified JSON format.`;
        const schema = { type: "OBJECT", properties: { "sectorDifferenceExplanation": { "type": "STRING" }, "sectorDifferenceSuggestions": { "type": "STRING" }, "geographicDifferenceExplanation": { "type": "STRING" }, "geographicDifferenceSuggestions": { "type": "STRING" } }, required: ["sectorDifferenceExplanation", "sectorDifferenceSuggestions", "geographicDifferenceExplanation", "geographicDifferenceSuggestions"] };
        const geminiModel = "gemini-2.0-flash";
        const geminiApiPayload = { contents: [{ role: "user", parts: [{ text: promptTextForGemini }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } };
        const proxyUrl = "/api/geminiProxy";
        try {
            const response = await fetch(proxyUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ model: geminiModel, geminiPayload: geminiApiPayload }) });
            const result = await response.json();
            if (!response.ok) { const errorDetail = result?.error || `Proxy request failed with status ${response.status}`; console.error('Error from proxy for difference analysis:', result); throw new Error(errorDetail); }
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                const analysis = JSON.parse(result.candidates[0].content.parts[0].text);
                domElements.sectorDifferenceExplanation.textContent = analysis.sectorDifferenceExplanation || "No specific explanation provided.";
                domElements.sectorDifferenceSuggestions.textContent = analysis.sectorDifferenceSuggestions || "No specific suggestions provided.";
                domElements.geographicDifferenceExplanation.textContent = analysis.geographicDifferenceExplanation || "No specific explanation provided.";
                domElements.geographicDifferenceSuggestions.textContent = analysis.geographicDifferenceSuggestions || "No specific suggestions provided.";
            } else { console.error('Unexpected data structure from proxy/Gemini (Difference Analysis):', result); throw new Error('Could not extract difference analysis from API response via proxy.'); }
        } catch (error) { console.error('Error fetching AI difference analysis (via proxy):', error); const displayMessage = error instanceof Error && error.message ? error.message : String(error); domElements.aiDifferenceAnalysisError.textContent = `Failed to load difference analysis. ${displayMessage || 'An unexpected error occurred.'} Please try again.`;
        } finally { domElements.aiDifferenceAnalysisLoading.classList.add('hidden'); domElements.aiDifferenceAnalysisCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
    }

    document.addEventListener('DOMContentLoaded', () => {
        domElements.profileButtons = document.querySelectorAll('.profile-btn');
        domElements.indicatorCardHeaders = document.querySelectorAll('.indicator-header');
        if (domElements.currentYearSpan) domElements.currentYearSpan.textContent = new Date().getFullYear();
        normalizeETFData();
        generateInputFields(domElements.sectorInputsDiv, CONFIG.SECTORS, 'sector', () => updateTotalAllocation('sector'));
        generateInputFields(domElements.geoInputsDiv, CONFIG.GEOGRAPHIES, 'geo', () => updateTotalAllocation('geo'));
        domElements.baseProfileInfoSpan.classList.add('hidden'); 
        domElements.profileButtons.forEach(btn => btn.addEventListener('click', handleReadyMadeProfileClick));
        domElements.generatePortfolioBtn.addEventListener('click', handleGeneratePortfolio);
        domElements.recalculateInsightsBtn.addEventListener('click', handleRecalculatePortfolioInsights);
        domElements.getAiInsightsBtn.addEventListener('click', handleGetAiInsights);
        domElements.getDiversificationSuggestionsBtn.addEventListener('click', handleGetDiversificationSuggestions);
        domElements.refineProfileWithAiBtn.addEventListener('click', handleRefineProfileWithAi); 
        domElements.getDifferenceAnalysisBtn.addEventListener('click', handleAnalyzeAllocationDifferences); 
        domElements.indicatorCardHeaders.forEach(header => header.addEventListener('click', toggleIndicatorDetails));
        updateTotalAllocation('sector');
        updateTotalAllocation('geo');
    });
</script>
</body>
</html>
